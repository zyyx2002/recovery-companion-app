name: ğŸš€ æˆ’æ–­åº·å¤APP - ç®€åŒ–æ„å»º

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

jobs:
  build-android:
    name: ğŸ“± æ„å»ºAndroid APK
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ è®¾ç½®Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: './mobile/package-lock.json'
        
    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      working-directory: ./mobile
      run: |
        npm ci
        npm install -g @expo/eas-cli@latest
        
    - name: ğŸ”§ é…ç½®EAS
      working-directory: ./mobile
      run: |
        eas login --non-interactive
        
    - name: ğŸ—ï¸ æ„å»ºAndroid APK
      working-directory: ./mobile
      run: |
        eas build --platform android --profile preview --non-interactive --wait
        
    - name: ğŸ“¥ ä¸‹è½½APKæ–‡ä»¶
      working-directory: ./mobile
      run: |
        # è·å–æœ€æ–°æ„å»ºçš„ä¸‹è½½é“¾æ¥
        BUILD_URL=$(eas build:list --platform android --limit 1 --json | jq -r '.[0].artifacts.buildUrl')
        echo "ä¸‹è½½é“¾æ¥: $BUILD_URL"
        
        # ä¸‹è½½APKæ–‡ä»¶
        curl -L -o app-release.apk "$BUILD_URL"
        echo "âœ… APKä¸‹è½½å®Œæˆ"
        ls -la app-release.apk
        
    - name: ğŸ“¤ ä¸Šä¼ APKåˆ°Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: android-apk-${{ github.sha }}
        path: mobile/app-release.apk
        retention-days: 30
        
    - name: ğŸ“¤ åˆ›å»ºGitHub Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: mobile/app-release.apk
        draft: false
        prerelease: false
        body: |
          ğŸ‰ æˆ’æ–­åº·å¤APPæ–°ç‰ˆæœ¬å‘å¸ƒï¼
          
          ğŸ“± **Android APKä¸‹è½½**
          - ç›´æ¥ä¸‹è½½APKæ–‡ä»¶å®‰è£…åˆ°Androidè®¾å¤‡
          
          ğŸ”§ **ç‰ˆæœ¬ä¿¡æ¯**
          - æ„å»ºæ—¶é—´: ${{ github.event.head_commit.timestamp }}
          - æäº¤: ${{ github.sha }}
          
          ğŸ“‹ **å®‰è£…è¯´æ˜**
          1. ä¸‹è½½APKæ–‡ä»¶
          2. åœ¨Androidè®¾å¤‡ä¸Šå¯ç”¨"æœªçŸ¥æ¥æº"å®‰è£…
          3. å®‰è£…APKæ–‡ä»¶
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
