name: ğŸš€ æˆ’æ–­åº·å¤APPè‡ªåŠ¨æ„å»º

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

jobs:
  # æ„å»ºAndroid APK
  build-android:
    name: ğŸ“± æ„å»ºAndroid APK
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ è®¾ç½®Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: mobile/package-lock.json
        
    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      working-directory: ./mobile
      run: |
        npm ci
        npm install -g @expo/eas-cli@latest
        
    - name: ğŸ”§ é…ç½®EAS
      working-directory: ./mobile
      run: |
        eas login --non-interactive
        eas project:info
        
    - name: ğŸ—ï¸ æ„å»ºAndroidé¢„è§ˆç‰ˆ
      if: github.ref != 'refs/heads/main' && !startsWith(github.ref, 'refs/tags/')
      working-directory: ./mobile
      run: |
        eas build --platform android --profile preview --non-interactive --wait
        
    - name: ğŸ—ï¸ æ„å»ºAndroidç”Ÿäº§ç‰ˆ
      if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')
      working-directory: ./mobile
      run: |
        eas build --platform android --profile production --non-interactive --wait
        
    - name: ğŸ“¥ ä¸‹è½½æ„å»ºæ–‡ä»¶
      working-directory: ./mobile
      run: |
        # è·å–æœ€æ–°æ„å»ºçš„ä¸‹è½½é“¾æ¥
        BUILD_URL=$(eas build:list --platform android --limit 1 --json | jq -r '.[0].artifacts.buildUrl')
        echo "ä¸‹è½½é“¾æ¥: $BUILD_URL"
        
        # ä¸‹è½½æ„å»ºæ–‡ä»¶
        if [[ $BUILD_URL == *.aab ]]; then
          curl -L -o app-release.aab "$BUILD_URL"
          echo "âœ… ä¸‹è½½äº†AABæ–‡ä»¶"
        else
          curl -L -o app-release.apk "$BUILD_URL"
          echo "âœ… ä¸‹è½½äº†APKæ–‡ä»¶"
        fi
        
    - name: ğŸ“¤ ä¸Šä¼ åˆ°Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: android-build-${{ github.sha }}
        path: |
          mobile/app-release.apk
          mobile/app-release.aab
        retention-days: 30
        
    - name: ğŸš€ å‘å¸ƒåˆ°Google Play Store
      if: startsWith(github.ref, 'refs/tags/')
      uses: r0adkll/upload-google-play@v1.1.3
      with:
        serviceAccountJsonPlainText: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT }}
        packageName: com.recoverycompanion.app
        releaseFiles: mobile/app-release.aab
        track: production
        status: completed
        inAppUpdatePriority: 2
        userFraction: 1.0
        whatsNewDirectory: mobile/release-notes/
        mappingFile: mobile/android/app/build/outputs/mapping/release/mapping.txt
        
    - name: ğŸ“¤ ä¸Šä¼ åˆ°GitHub Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          mobile/app-release.apk
          mobile/app-release.aab
        draft: false
        prerelease: false
        body_path: mobile/release-notes/zh-CN/default.txt
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # æ„å»ºiOSåº”ç”¨
  build-ios:
    name: ğŸ æ„å»ºiOSåº”ç”¨
    runs-on: macos-latest
    if: github.event_name == 'workflow_dispatch' || startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ è®¾ç½®Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: mobile/package-lock.json
        
    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      working-directory: ./mobile
      run: |
        npm ci
        npm install -g @expo/eas-cli@latest
        
    - name: ğŸ”§ é…ç½®EAS
      working-directory: ./mobile
      run: |
        eas login --non-interactive
        eas project:info
        
    - name: ğŸ—ï¸ æ„å»ºiOSåº”ç”¨
      working-directory: ./mobile
      run: |
        eas build --platform ios --profile preview --non-interactive --wait
        
    - name: ğŸ“¤ ä¸Šä¼ iOSåº”ç”¨åˆ°Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ios-app-${{ github.sha }}
        path: mobile/*.ipa
        retention-days: 30

  # éƒ¨ç½²Webç‰ˆæœ¬
  deploy-web:
    name: ğŸŒ éƒ¨ç½²Webç‰ˆæœ¬
    runs-on: ubuntu-latest
    needs: [build-android]
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ è®¾ç½®Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: mobile/package-lock.json
        
    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      working-directory: ./mobile
      run: npm ci
      
    - name: ğŸ—ï¸ æ„å»ºWebç‰ˆæœ¬
      working-directory: ./mobile
      run: |
        npm run web:build
        
    - name: ğŸš€ éƒ¨ç½²åˆ°Vercel
      uses: amondnet/vercel-action@v25
      with:
        vercel-token: ${{ secrets.VERCEL_TOKEN }}
        vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
        vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
        working-directory: ./mobile
        vercel-args: '--prod'

  # é€šçŸ¥æ„å»ºç»“æœ
  notify:
    name: ğŸ“¢ é€šçŸ¥æ„å»ºç»“æœ
    runs-on: ubuntu-latest
    needs: [build-android, deploy-web]
    if: always()
    
    steps:
    - name: ğŸ“¢ å‘é€é€šçŸ¥
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        channel: '#builds'
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}
      if: always()
